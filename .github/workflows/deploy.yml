
name: Despliegue a Producci√≥n

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
      
      - name: Despliegue FTP a Producci√≥n
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: /katalyst.ddelacortep.tech/htdocs/
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/**

            **/vendor/**
            **/storage/logs/**
            **/storage/framework/cache/**
            **/storage/framework/sessions/**
            **/composer.lock
            **/package-lock.json
      
      - name: Crear archivo marcador para limpieza de cach√©
        run: touch storage/cache-reset.flag
      
      - name: Subir archivo marcador v√≠a FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./storage/
          server-dir: /portfolio.ddelacortep.tech/htdocs/storage/
          dangerous-clean-slate: false
      
      - name: Esperar a que los archivos se sincronicen
        run: sleep 2
      
      - name: Ejecutar limpieza de cach√© - M√©todo 1 (HTTP PHP)
        run: |
          echo "üîÑ Intentando limpiar cach√© v√≠a HTTP..."
          curl -s "https://portfolio.ddelacortep.tech/clear-cache.php?token=${{ secrets.CLEAR_CACHE_TOKEN }}" || echo "‚ö†Ô∏è  Script PHP no disponible"
      
      - name: Ejecutar limpieza de cach√© - M√©todo 2 (Acceso a la app)
        run: |
          echo "üîÑ La pr√≥xima visita a la web limpiar√° el cach√© autom√°ticamente..."
          echo "‚úÖ Deploy completado exitosamente"
